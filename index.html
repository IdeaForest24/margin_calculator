<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eBay 판매 마진 계산기 v2.1 (수정판)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            background-color: #f9fafb;
            color: #374151;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
            background-color: white;
            min-height: 100vh;
        }
        
        .header {
            margin-bottom: 32px;
        }
        
        .header h1 {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 30px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 16px;
        }
        
        .version-badge {
            background: linear-gradient(45deg, #3b82f6, #16a34a);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .header p {
            color: #6b7280;
        }
        
        .top-bar {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 24px;
            align-items: center;
            margin-top: 16px;
            margin-bottom: 24px;
        }
        
        @media (max-width: 768px) {
            .top-bar {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }
        
        .exchange-rate-info {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .exchange-rate-info .rate {
            font-weight: 600;
            color: #1d4ed8;
        }
        
        .refresh-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .refresh-btn:hover {
            background: #2563eb;
        }
        
        .excel-upload-compact {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 2px dashed #0ea5e9;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
            min-width: 280px;
            cursor: pointer;
        }
        
        .excel-upload-compact:hover {
            border-color: #0284c7;
            background: linear-gradient(135deg, #e0f2fe, #bae6fd);
            transform: scale(1.02);
        }
        
        .excel-upload-compact .upload-icon {
            font-size: 24px;
            color: #0ea5e9;
            margin-bottom: 8px;
        }
        
        .excel-upload-compact .upload-text {
            font-size: 14px;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 4px;
        }
        
        .excel-upload-compact .upload-subtext {
            font-size: 12px;
            color: #64748b;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-status {
            margin-bottom: 16px;
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .upload-status.success {
            background: #dcfce7;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }
        
        .upload-status.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .upload-status.info {
            background: #eff6ff;
            color: #2563eb;
            border: 1px solid #dbeafe;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 32px;
        }
        
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .input-section {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        .section {
            padding: 24px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .section.blue { background-color: #eff6ff; border-color: #dbeafe; }
        .section.orange { background-color: #fff7ed; border-color: #fed7aa; }
        .section.green { background-color: #f0fdf4; border-color: #bbf7d0; }
        .section.red { background-color: #fef2f2; border-color: #fecaca; }
        .section.yellow { background-color: #fffbeb; border-color: #fde68a; }
        .section.gray { background-color: #f9fafb; border-color: #e5e7eb; }
        .section.purple { background-color: #faf5ff; border-color: #e9d5ff; }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .section-header.blue { color: #1d4ed8; }
        .section-header.orange { color: #ea580c; }
        .section-header.green { color: #16a34a; }
        .section-header.red { color: #dc2626; }
        .section-header.yellow { color: #d97706; }
        .section-header.gray { color: #374151; }
        .section-header.purple { color: #9333ea; }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full {
            grid-column: span 2;
        }
        
        @media (max-width: 768px) {
            .form-group.full {
                grid-column: span 1;
            }
        }
        
        label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }
        
        input, select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .help-text {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .dimension-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }
        
        .info-box {
            font-size: 14px;
            color: #1d4ed8;
            background-color: #eff6ff;
            padding: 12px;
            border-radius: 6px;
            margin-top: 16px;
        }
        
        .calculate-btn {
            width: 100%;
            background: linear-gradient(to right, #2563eb, #16a34a);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .calculate-btn:hover {
            background: linear-gradient(to right, #1d4ed8, #15803d);
            transform: translateY(-1px);
        }
        
        .calculate-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .results-section {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 14px;
        }
        
        .result-item.header {
            font-weight: 600;
            font-size: 16px;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 8px;
            margin-bottom: 8px;
        }
        
        .result-item.total {
            font-weight: 600;
            font-size: 18px;
            border-top: 1px solid #e5e7eb;
            padding-top: 8px;
            margin-top: 8px;
        }
        
        .text-red { color: #dc2626; }
        .text-green { color: #16a34a; }
        .text-blue { color: #2563eb; }
        .text-gray { color: #6b7280; }
        .text-purple { color: #9333ea; }
        
        .hidden { display: none; }
        
        ul {
            list-style: none;
            padding-left: 0;
        }
        
        li {
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .service-type-toggle {
            display: flex;
            background: #f3f4f6;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 16px;
        }
        
        .service-type-option {
            flex: 1;
            padding: 8px 16px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
        }
        
        .service-type-option.active {
            background: white;
            color: #1d4ed8;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .service-type-option:not(.active) {
            color: #6b7280;
        }
        
        .service-type-option:hover:not(.active) {
            background: #e5e7eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                📈 eBay 판매 마진 계산기 <span class="version-badge">v2.1</span>
            </h1>
            
            <div class="top-bar">
                <div class="exchange-rate-info">
                    <div>
                        <span>💱 실시간 환율: </span>
                        <span class="rate" id="exchangeRateDisplay">1 USD = 로딩중...</span>
                        <span id="lastUpdated" class="text-gray"></span>
                    </div>
                    <button class="refresh-btn" onclick="fetchExchangeRate()">
                        <span id="refreshIcon">🔄</span> 갱신
                    </button>
                </div>
                
                <div class="excel-upload-compact" id="uploadSection" onclick="document.getElementById('excelFile').click()">
                    <div class="upload-icon">📋</div>
                    <div class="upload-text">eGS 운임표 업로드</div>
                    <div class="upload-subtext">엑셀 파일 (.xlsx, .xls)</div>
                    <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls" onchange="handleFileUpload(event)">
                </div>
            </div>
            
            <div id="uploadStatus" class="upload-status hidden"></div>
        </div>

        <div class="main-grid">
            <div class="input-section">
                <div class="section blue">
                    <div class="section-header blue">
                        📦 제품 원가 정보
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="productCost">제품 원가 (원)</label>
                            <input type="number" id="productCost" placeholder="">
                        </div>
                        <div class="form-group">
                            <label for="supplierShipping">매입처 배송비 (원)</label>
                            <input type="number" id="supplierShipping" placeholder="">
                        </div>
                    </div>
                </div>

                <div class="section orange">
                    <div class="section-header orange">
                        🚚 상품 정보 및 배송
                    </div>
                    
                    <div class="service-type-toggle">
                        <div class="service-type-option active" onclick="toggleServiceType('standard')">
                            🚛 eGS Standard (5-10일)
                        </div>
                        <div class="service-type-option" onclick="toggleServiceType('express')">
                            ✈️ eGS Express (2-5일)
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="weight">실제 중량 (kg)</label>
                            <input type="number" step="0.1" id="weight" placeholder="예시 : 0.5, 2">
                        </div>
                        <div class="form-group">
                            <label for="egsShipping">eGS 창고 입고비 (원)</label>
                            <input type="number" id="egsShipping" value="" placeholder="예시 : 3000, 3400">
                            <div class="help-text">GS25 반값택배 최저요금: 3,400원</div>
                        </div>
                    </div>
                    <div class="dimension-grid" style="margin-top: 16px;">
                        <div class="form-group">
                            <label for="length">가로 (cm)</label>
                            <input type="number" id="length" placeholder="">
                        </div>
                        <div class="form-group">
                            <label for="width">세로 (cm)</label>
                            <input type="number" id="width" placeholder="">
                        </div>
                        <div class="form-group">
                            <label for="height">높이 (cm)</label>
                            <input type="number" id="height" placeholder="">
                        </div>
                    </div>
                    <div id="weightInfo" class="info-box hidden"></div>
                </div>

                <div class="section green">
                    <div class="section-header green">
                        🌍 eBay 판매 정보
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="destination">목적지 *</label>
                            <select id="destination">
                                <option value="">목적지를 선택하세요</option>
                                <option value="US">미국 (US)</option>
                                <option value="CA">캐나다 (CA)</option>
                                <option value="GB">영국 (GB)</option>
                                <option value="DE">독일 (DE)</option>
                                <option value="FR">프랑스 (FR)</option>
                                <option value="IT">이탈리아 (IT)</option>
                                <option value="ES">스페인 (ES)</option>
                                <option value="EU">기타 유럽 (EU) - 독일 요금 적용</option>
                                <option value="AU">호주 (AU)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="category">eBay 카테고리 *</label>
                            <select id="category">
                                <option value="">카테고리를 선택하세요</option>
                                <option value="most_categories">대부분 카테고리 (일반)</option>
                                <option value="books_movies_music">도서/영화/음악</option>
                                <option value="womens_bags">여성용 가방/핸드백</option>
                                <option value="athletic_shoes">운동화 (남성/여성)</option>
                                <option value="jewelry_watches">보석/시계 (일반)</option>
                                <option value="watches_parts">시계/부품/액세서리</option>
                                <option value="coins_paper_money">동전/지폐 (금괴제외)</option>
                                <option value="bullion">금괴/귀금속</option>
                                <option value="guitars_basses">악기 (기타/베이스)</option>
                                <option value="trading_cards">트레이딩 카드</option>
                                <option value="nft_categories">NFT 카테고리</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid" style="margin-top: 16px;">
                        <div class="form-group">
                            <label for="storeType">eBay 스토어 구독</label>
                            <select id="storeType">
                                <option value="none">스토어 없음/Starter</option>
                                <option value="basic">Basic 이상 스토어</option>
                            </select>
                            <div class="help-text">스토어 구독 시 수수료 할인</div>
                        </div>
                        <div class="form-group">
                            <label for="isKoreanSeller">한국 판매자 여부</label>
                            <select id="isKoreanSeller">
                                <option value="true">한국 판매자 (VAT 10% 적용)</option>
                                <option value="false">해외 판매자</option>
                            </select>
                            <div class="help-text">한국 판매자는 VAT 10% 추가</div>
                        </div>
                    </div>
                    <div class="form-group full" style="margin-top: 16px;">
                        <label for="targetMargin">목표 마진율 (%)</label>
                        <input type="number" step="1" id="targetMargin" value="" placeholder="예시 : 20">
                    </div>
                </div>

                <button class="calculate-btn" onclick="calculateMargin()">
                    🧮 마진 계산하기
                </button>
            </div>

            <div class="results-section">
                <!-- 결과가 표시될 컨테이너 -->
                <div id="resultsContainer" class="hidden">
                    <div class="section green">
                        <div class="section-header green">
                            📊 계산 결과 상세
                        </div>
                        <!-- 모든 결과가 여기에 표시됨 -->
                        <div id="resultDetails"></div>
                    </div>
                     <div class="section blue">
                        <div class="section-header blue">
                            ⚙️ 계산 설정 정보
                        </div>
                        <div id="settingsInfo"></div>
                    </div>
                </div>

                <!-- 기본 안내 메시지 -->
                <div id="usageGuide" class="section blue">
                    <div class="section-header blue">
                        📖 사용 방법
                    </div>
                    <ul>
                        <li>• <strong>1단계:</strong> eGS 운임표 엑셀 파일을 업로드하세요</li>
                        <li>• <strong>2단계:</strong> 제품 정보(원가, 중량, 치수)를 입력하세요</li>
                        <li>• <strong>3단계:</strong> 배송 목적지와 eBay 카테고리를 선택하세요</li>
                        <li>• <strong>4단계:</strong> 목표 마진율을 설정하고 계산하기를 클릭하세요</li>
                        <li>• 💡 <strong>v2.1 업데이트:</strong> UI 버그 수정 및 결과 표시 방식 개선</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let currentExchangeRate = 1300;
        let currentServiceType = 'standard';
        let egsRatesData = null;

        const ebayCategories = {
            'most_categories': { 
                name: '대부분 카테고리 (일반)', 
                noStore: { rate: 13.6, threshold: 7500, overRate: 2.35 },
                withStore: { rate: 12.7, threshold: 2500, overRate: 2.35 }
            },
            'books_movies_music': { 
                name: '도서/영화/음악', 
                noStore: { rate: 15.3, threshold: 7500, overRate: 2.35 },
                withStore: { rate: 15.3, threshold: 2500, overRate: 2.35 }
            },
            'womens_bags': { 
                name: '여성용 가방/핸드백', 
                noStore: { rate: 15.0, threshold: 2000, overRate: 9.0 },
                withStore: { rate: 13.0, threshold: 2000, overRate: 7.0 }
            },
            'athletic_shoes': { 
                name: '운동화 (남성/여성)', 
                noStore: { rate: 8.0, minAmount: 150, belowMinRate: 13.6 },
                withStore: { rate: 7.0, minAmount: 150, belowMinRate: 12.7 }
            },
            'jewelry_watches': { 
                name: '보석/시계 (일반)', 
                noStore: { rate: 15.0, threshold: 5000, overRate: 9.0 },
                withStore: { rate: 13.0, threshold: 5000, overRate: 7.0 }
            },
            'watches_parts': { 
                name: '시계/부품/액세서리', 
                noStore: { rate: 15.0, threshold1: 1000, rate1: 6.5, threshold2: 7500, rate2: 3.0 },
                withStore: { rate: 12.5, threshold1: 1000, rate1: 4.0, threshold2: 5000, rate2: 3.0 }
            },
            'coins_paper_money': { 
                name: '동전/지폐 (금괴제외)', 
                noStore: { rate: 13.25, threshold: 7500, overRate: 2.35 },
                withStore: { rate: 9.0, threshold: 4000, overRate: 2.35 }
            },
            'bullion': { 
                name: '금괴/귀금속', 
                noStore: { rate: 13.6, threshold: 7500, overRate: 7.0 },
                withStore: { rate: 7.5, threshold1: 1500, rate1: 5.0, threshold2: 10000, rate2: 4.5 }
            },
            'guitars_basses': { 
                name: '악기 (기타/베이스)', 
                noStore: { rate: 6.7, threshold: 7500, overRate: 2.35 },
                withStore: { rate: 6.7, threshold: 2500, overRate: 2.35 }
            },
            'trading_cards': { 
                name: '트레이딩 카드', 
                noStore: { rate: 13.25, threshold: 7500, overRate: 2.35 },
                withStore: { rate: 12.35, threshold: 2500, overRate: 2.35 }
            },
            'nft_categories': { 
                name: 'NFT 카테고리', 
                noStore: { rate: 5.0 },
                withStore: { rate: 5.0 }
            }
        };

        const destinations = {
            US: '미국', CA: '캐나다', GB: '영국', DE: '독일', 
            FR: '프랑스', IT: '이탈리아', ES: '스페인', 
            EU: '기타 유럽 (독일 요금)', AU: '호주'
        };

        window.addEventListener('load', function() {
            fetchExchangeRate();
            loadSavedRatesData();
            setupDragAndDrop();
        });

        function loadSavedRatesData() {
            try {
                const savedData = localStorage.getItem('egsRatesData');
                const lastUpdate = localStorage.getItem('egsRatesLastUpdate');
                
                if (savedData) {
                    egsRatesData = JSON.parse(savedData);
                    showUploadStatus(`✅ 저장된 운임표 로드됨 (${new Date(lastUpdate).toLocaleDateString()})`, 'success');
                } else {
                    showUploadStatus('⚠️ 운임표를 업로드해주세요. 업로드하지 않으면 계산이 불가능합니다.', 'info');
                }
            } catch (error) {
                console.error('저장된 데이터 로드 오류:', error);
                showUploadStatus('❌ 저장된 운임표 로드 실패. 새로 업로드해주세요.', 'error');
            }
        }

        function setupDragAndDrop() {
            const uploadSection = document.getElementById('uploadSection');
            
            uploadSection.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadSection.style.borderColor = '#0284c7';
                uploadSection.style.background = 'linear-gradient(135deg, #e0f2fe, #bae6fd)';
                uploadSection.style.transform = 'scale(1.02)';
            });
            
            uploadSection.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadSection.style.borderColor = '#0ea5e9';
                uploadSection.style.background = 'linear-gradient(135deg, #f0f9ff, #e0f2fe)';
                uploadSection.style.transform = 'scale(1)';
            });
            
            uploadSection.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadSection.style.borderColor = '#0ea5e9';
                uploadSection.style.background = 'linear-gradient(135deg, #f0f9ff, #e0f2fe)';
                uploadSection.style.transform = 'scale(1)';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload({ target: { files: files } });
                }
            });
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
                               'application/vnd.ms-excel'];
            if (!validTypes.includes(file.type)) {
                showUploadStatus('❌ Excel 파일만 업로드 가능합니다 (.xlsx, .xls)', 'error');
                return;
            }

            showUploadStatus('📤 파일 업로드 중...', 'info');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const parsedData = parseExcelWorkbook(workbook);
                    
                    if (parsedData) {
                        egsRatesData = parsedData;
                        
                        localStorage.setItem('egsRatesData', JSON.stringify(parsedData));
                        localStorage.setItem('egsRatesLastUpdate', new Date().toISOString());
                        
                        showUploadStatus(`✅ 운임표 업로드 완료! (${file.name})`, 'success');
                    } else {
                        showUploadStatus('❌ 운임표 형식이 올바르지 않습니다.', 'error');
                    }
                } catch (error) {
                    console.error('파일 파싱 오류:', error);
                    showUploadStatus('❌ 파일 읽기 실패. 다른 파일을 시도해보세요.', 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function parseExcelWorkbook(workbook) {
            try {
                const result = {
                    standard: {},
                    express: {}
                };

                result.standard = parseStandardSheets(workbook);
                result.express = parseExpressSheet(workbook);

                if (Object.keys(result.standard).length === 0 && Object.keys(result.express).length === 0) {
                    return null;
                }

                return result;
            } catch (error) {
                console.error('엑셀 파싱 오류:', error);
                return null;
            }
        }

        function parseStandardSheets(workbook) {
            const standardData = {};
            
            try {
                const usSheet = workbook.Sheets['eGS Standard - US'];
                if (usSheet) {
                    const usData = XLSX.utils.sheet_to_json(usSheet, { header: 1 });
                    standardData.US = parseStandardUSSheet(usData);
                }

                const caSheet = workbook.Sheets['eGS Standard - CA'];
                if (caSheet) {
                    const caData = XLSX.utils.sheet_to_json(caSheet, { header: 1 });
                    standardData.CA = parseStandardGenericSheet(caData, 7);
                }

                const gbSheet = workbook.Sheets['eGS Standard - GB'];
                if (gbSheet) {
                    const gbData = XLSX.utils.sheet_to_json(gbSheet, { header: 1 });
                    standardData.GB = parseStandardGenericSheet(gbData, 7);
                }

                const auSheet = workbook.Sheets['eGS Standard - AU'];
                if (auSheet) {
                    const auData = XLSX.utils.sheet_to_json(auSheet, { header: 1 });
                    standardData.AU = parseStandardGenericSheet(auData, 6);
                }

                const euSheet = workbook.Sheets['eGS Standard - EU'];
                if (euSheet) {
                    const euData = XLSX.utils.sheet_to_json(euSheet, { header: 1 });
                    const euCountriesData = parseStandardEUSheet(euData);
                    if (euCountriesData) {
                        Object.keys(euCountriesData).forEach(countryCode => {
                            standardData[countryCode] = euCountriesData[countryCode];
                        });
                    }
                }

                return standardData;
            } catch (error) {
                console.error('Standard 시트 파싱 오류:', error);
                return {};
            }
        }

        function parseExpressSheet(workbook) {
            const expressData = {};
            
            try {
                const expressSheet = workbook.Sheets['eGS Express'];
                if (!expressSheet) return {};

                const data = XLSX.utils.sheet_to_json(expressSheet, { header: 1 });
                
                const zoneHeader = data[3];
                if (!zoneHeader) return {};

                const zoneMapping = {
                    'US': { zone: 'E', index: zoneHeader.indexOf('E') },
                    'CA': { zone: 'F', index: zoneHeader.indexOf('F') },
                    'GB': { zone: 'M', index: zoneHeader.indexOf('M') },
                    'AU': { zone: 'U', index: zoneHeader.indexOf('U') }
                };

                for (let row = 5; row < data.length; row++) {
                    const rowData = data[row];
                    if (!rowData || typeof rowData[0] !== 'number') continue;
                    
                    const weight = rowData[0];
                    
                    Object.keys(zoneMapping).forEach(country => {
                        const { index } = zoneMapping[country];
                        if (index !== -1 && typeof rowData[index] === 'number') {
                            if (!expressData[country]) {
                                expressData[country] = [];
                            }
                            expressData[country].push({
                                weight: weight,
                                price: rowData[index]
                            });
                        }
                    });
                }

                if (expressData.GB) {
                    expressData.DE = [...expressData.GB];
                    expressData.FR = [...expressData.GB];
                    expressData.IT = [...expressData.GB];
                    expressData.ES = [...expressData.GB];
                    expressData.EU = [...expressData.GB];
                }

                return expressData;
            } catch (error) {
                console.error('Express 시트 파싱 오류:', error);
                return {};
            }
        }

        function parseStandardUSSheet(data) {
            const result = [];
            
            for (let row = 4; row < data.length; row++) {
                const rowData = data[row];
                if (!rowData || rowData.length < 3) continue;
                
                const weight = parseFloat(rowData[1]);
                const price = parseFloat(rowData[2]);
                
                if (!isNaN(weight) && !isNaN(price) && weight > 0 && price > 0) {
                    result.push({ weight, price });
                }
            }
            
            return result.length > 0 ? result : null;
        }

        function parseStandardGenericSheet(data, startRow) {
            const result = [];
            
            for (let row = startRow; row < data.length; row++) {
                const rowData = data[row];
                if (!rowData || rowData.length < 2) continue;
                
                const weight = parseFloat(rowData[0]);
                const price = parseFloat(rowData[1]);
                
                if (!isNaN(weight) && !isNaN(price) && weight > 0 && price > 0) {
                    result.push({ weight, price });
                }
            }
            
            return result.length > 0 ? result : null;
        }

        function parseStandardEUSheet(data) {
            const results = {};
            
            try {
                const headerRow = data[2];
                if (!headerRow) return null;
                
                const countryMapping = {
                    'FR': 'France',
                    'DE': 'Germany', 
                    'IT': 'Italy',
                    'ES': 'Spain'
                };
                
                const countryIndices = {};
                Object.keys(countryMapping).forEach(code => {
                    const countryName = countryMapping[code];
                    for (let i = 0; i < headerRow.length; i++) {
                        if (headerRow[i] && headerRow[i].includes(countryName)) {
                            countryIndices[code] = i;
                            break;
                        }
                    }
                });
                
                Object.keys(countryIndices).forEach(countryCode => {
                    const columnIndex = countryIndices[countryCode];
                    const countryData = [];
                    
                    for (let row = 3; row < data.length; row++) {
                        const rowData = data[row];
                        if (!rowData || rowData.length <= columnIndex) continue;
                        
                        const weight = parseFloat(rowData[0]);
                        const price = parseFloat(rowData[columnIndex]);
                        
                        if (!isNaN(weight) && !isNaN(price) && weight > 0 && price > 0) {
                            countryData.push({ weight, price });
                        }
                    }
                    
                    if (countryData.length > 0) {
                        results[countryCode] = countryData;
                    }
                });
                
                if (results.DE) {
                    results.EU = [...results.DE];
                }
                
                return Object.keys(results).length > 0 ? results : null;
            } catch (error) {
                console.error('EU 시트 파싱 오류:', error);
                return null;
            }
        }

        function showUploadStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.textContent = message;
            statusDiv.className = `upload-status ${type}`;
            statusDiv.classList.remove('hidden');
        }

        async function fetchExchangeRate() {
            const refreshIcon = document.getElementById('refreshIcon');
            const exchangeRateDisplay = document.getElementById('exchangeRateDisplay');
            const lastUpdated = document.getElementById('lastUpdated');
            
            refreshIcon.innerHTML = '<div class="loading"></div>';
            
            try {
                const response = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent('https://api.exchangerate-api.com/v4/latest/USD'));
                const data = await response.json();
                
                if (data.rates && data.rates.KRW) {
                    currentExchangeRate = data.rates.KRW;
                    exchangeRateDisplay.textContent = `1 USD = ${currentExchangeRate.toLocaleString()}원`;
                    lastUpdated.textContent = `(${new Date().toLocaleTimeString()} 업데이트)`;
                } else {
                    throw new Error('환율 데이터를 가져올 수 없습니다');
                }
            } catch (error) {
                console.error('환율 API 오류:', error);
                exchangeRateDisplay.innerHTML = `
                    <input type="number" id="manualExchangeRate" value="1300" 
                           style="width: 80px; padding: 2px 6px; border: 1px solid #d1d5db; border-radius: 4px;"
                           onchange="updateManualExchangeRate(this.value)">원 (수동 입력)
                `;
                lastUpdated.textContent = '(API 오류로 수동 입력 모드)';
                currentExchangeRate = 1300;
            }
            
            refreshIcon.innerHTML = '🔄';
        }

        function updateManualExchangeRate(value) {
            const rate = parseFloat(value);
            if (rate && rate > 0) {
                currentExchangeRate = rate;
                document.getElementById('lastUpdated').textContent = `(${new Date().toLocaleTimeString()} 수동 업데이트)`;
            }
        }

        function toggleServiceType(type) {
            currentServiceType = type;
            
            document.querySelectorAll('.service-type-option').forEach(option => {
                option.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateWeightInfo();
        }

        function calculateVolumetricWeight() {
            const length = parseFloat(document.getElementById('length').value) || 0;
            const width = parseFloat(document.getElementById('width').value) || 0;
            const height = parseFloat(document.getElementById('height').value) || 0;
            
            if (length && width && height) {
                return (length * width * height) / 6000;
            }
            return 0;
        }

        function getFinalWeight() {
            const actualWeight = parseFloat(document.getElementById('weight').value) || 0;
            const volumetricWeight = calculateVolumetricWeight();
            return Math.max(actualWeight, volumetricWeight);
        }

        function calculateEgsShipping(targetWeight, destination) {
            if (!egsRatesData) {
                return 0;
            }

            const serviceData = egsRatesData[currentServiceType];
            if (!serviceData || !serviceData[destination]) {
                return 0;
            }

            const rates = serviceData[destination];
            if (!rates || rates.length === 0) {
                return 0;
            }

            const exactMatch = rates.find(rate => rate.weight === targetWeight);
            if (exactMatch) return exactMatch.price;

            const nextHigher = rates.find(rate => rate.weight > targetWeight);
            if (nextHigher) return nextHigher.price;

            const lastRate = rates[rates.length - 1];
            if (targetWeight > lastRate.weight) {
                const previousRate = rates[rates.length - 2] || lastRate;
                const weightDiff = targetWeight - lastRate.weight;
                const pricePerKg = (lastRate.price - previousRate.price) / (lastRate.weight - previousRate.weight);
                return Math.round(lastRate.price + (weightDiff * pricePerKg));
            }

            return 0;
        }

        function calculateEbayFee(sellingPriceUSD, category, hasStore) {
            const categoryData = ebayCategories[category];
            const feeStructure = hasStore ? categoryData.withStore : categoryData.noStore;
            
            const transactionFee = sellingPriceUSD <= 10 ? 0.30 : 0.40;
            const internationalFee = sellingPriceUSD * 0.0165;
            
            let percentageFee = 0;
            
            if (feeStructure.threshold) {
                const baseRate = feeStructure.rate / 100;
                const overRate = feeStructure.overRate / 100;
                const threshold = feeStructure.threshold;
                
                if (sellingPriceUSD <= threshold) {
                    percentageFee = sellingPriceUSD * baseRate;
                } else {
                    const baseFee = threshold * baseRate;
                    const overFee = (sellingPriceUSD - threshold) * overRate;
                    percentageFee = baseFee + overFee;
                }
            } else if (feeStructure.minAmount) {
                if (sellingPriceUSD >= feeStructure.minAmount) {
                    percentageFee = sellingPriceUSD * (feeStructure.rate / 100);
                } else {
                    percentageFee = sellingPriceUSD * (feeStructure.belowMinRate / 100);
                }
            } else if (feeStructure.threshold1) {
                const threshold1 = feeStructure.threshold1;
                const threshold2 = feeStructure.threshold2;
                const rate1 = feeStructure.rate1 / 100;
                const rate2 = feeStructure.rate2 / 100;
                const baseRate = feeStructure.rate / 100;
                
                if (sellingPriceUSD <= threshold1) {
                    percentageFee = sellingPriceUSD * baseRate;
                } else if (sellingPriceUSD <= threshold2) {
                    const baseFee = threshold1 * baseRate;
                    const midFee = (sellingPriceUSD - threshold1) * rate1;
                    percentageFee = baseFee + midFee;
                } else {
                    const baseFee = threshold1 * baseRate;
                    const midFee = (threshold2 - threshold1) * rate1;
                    const topFee = (sellingPriceUSD - threshold2) * rate2;
                    percentageFee = baseFee + midFee + topFee;
                }
            } else {
                percentageFee = sellingPriceUSD * (feeStructure.rate / 100);
            }
            
            return {
                finalValueFee: percentageFee,
                perOrderFee: transactionFee,
                internationalFee: internationalFee,
                total: percentageFee + transactionFee + internationalFee
            };
        }

        function findTargetSellingPrice(totalCostUSD, targetMarginRate, category, hasStore, isKoreanSeller) {
            let low = totalCostUSD * 1.1;
            let high = totalCostUSD * 5.0;
            let bestPrice = high;
            
            for (let i = 0; i < 50; i++) {
                const midPrice = (low + high) / 2;
                
                const ebayFeeBreakdown = calculateEbayFee(midPrice, category, hasStore);
                const ebayFeeTotal = ebayFeeBreakdown.total;
                const vat = isKoreanSeller ? ebayFeeTotal * 0.1 : 0;
                const ebayTotalFee = ebayFeeTotal + vat;
                
                const ebayPayout = midPrice - ebayTotalFee;
                const payoneerWithdrawalFee = 1.00;
                const payoneerExchangeFee = ebayPayout * 0.012;
                const payoneerTotalFee = payoneerWithdrawalFee + payoneerExchangeFee;
                
                const finalReceive = ebayPayout - payoneerTotalFee;
                const netProfit = finalReceive - totalCostUSD;
                const actualMarginRate = (netProfit / midPrice) * 100;
                
                if (Math.abs(actualMarginRate - targetMarginRate) < 0.01) {
                    bestPrice = midPrice;
                    break;
                }
                
                if (actualMarginRate < targetMarginRate) {
                    low = midPrice;
                } else {
                    high = midPrice;
                    bestPrice = midPrice;
                }
            }
            
            return bestPrice;
        }

        function updateWeightInfo() {
            const volumetricWeight = calculateVolumetricWeight();
            const finalWeight = getFinalWeight();
            const weightInfo = document.getElementById('weightInfo');
            
            if (volumetricWeight > 0 || finalWeight > 0) {
                const serviceTypeText = currentServiceType === 'express' ? 'Express' : 'Standard';
                weightInfo.innerHTML = `
                    📦 부피 중량: ${volumetricWeight.toFixed(2)}kg | 과금 중량: ${finalWeight.toFixed(2)}kg<br>
                    🚚 선택된 서비스: eGS ${serviceTypeText}
                `;
                weightInfo.classList.remove('hidden');
            } else {
                weightInfo.classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('length').addEventListener('input', updateWeightInfo);
            document.getElementById('width').addEventListener('input', updateWeightInfo);
            document.getElementById('height').addEventListener('input', updateWeightInfo);
            document.getElementById('weight').addEventListener('input', updateWeightInfo);
        });

        function calculateMargin() {
            if (!egsRatesData) {
                alert('⚠️ 운임표를 먼저 업로드해주세요!');
                return;
            }

            const productCost = document.getElementById('productCost').value;
            const supplierShipping = document.getElementById('supplierShipping').value || 0;
            const weight = document.getElementById('weight').value;
            const destination = document.getElementById('destination').value;
            const category = document.getElementById('category').value;
            const egsShipping = document.getElementById('egsShipping').value || 3400;
            const targetMargin = document.getElementById('targetMargin').value;
            const storeType = document.getElementById('storeType').value;
            const isKoreanSeller = document.getElementById('isKoreanSeller').value === 'true';

            if (!productCost || !destination || !category || !weight || !targetMargin) {
                alert('모든 필수 항목을 입력해주세요.');
                return;
            }

            const finalWeight = getFinalWeight();
            const egsShippingCost = calculateEgsShipping(finalWeight, destination);
            
            if (egsShippingCost === 0) {
                alert(`⚠️ ${destinations[destination]} 배송비 정보가 없습니다. 엑셀 파일을 확인해주세요.`);
                return;
            }
            
            const totalCostKRW = 
                parseFloat(productCost) + 
                parseFloat(supplierShipping) + 
                parseFloat(egsShipping) + 
                egsShippingCost;

            const totalCostUSD = totalCostKRW / currentExchangeRate;
            const hasStore = storeType !== 'none';
            const targetMarginRate = parseFloat(targetMargin);
            
            const requiredSellingPriceUSD = findTargetSellingPrice(
                totalCostUSD, 
                targetMarginRate, 
                category, 
                hasStore, 
                isKoreanSeller
            );
            
            const ebayFeeBreakdown = calculateEbayFee(requiredSellingPriceUSD, category, hasStore);
            const vatUSD = isKoreanSeller ? ebayFeeBreakdown.total * 0.1 : 0;
            const ebayTotalFee = ebayFeeBreakdown.total + vatUSD;
            
            const ebayPayoutUSD = requiredSellingPriceUSD - ebayTotalFee;
            // Payoneer 출금 수수료는 고정 $1.5 이나, 현재 $1로 계산되고 있어 $1로 유지.
            const payoneerWithdrawalFee = 1.00;
            const payoneerExchangeFee = ebayPayoutUSD * 0.012;
            const payoneerTotalFee = payoneerWithdrawalFee + payoneerExchangeFee;
            
            const finalReceiveUSD = ebayPayoutUSD - payoneerTotalFee;
            const finalReceiveKRW = finalReceiveUSD * currentExchangeRate;
            
            const netProfitUSD = finalReceiveUSD - totalCostUSD;
            const netProfitKRW = netProfitUSD * currentExchangeRate;
            const actualMarginRate = (netProfitUSD / requiredSellingPriceUSD) * 100;

            displayResults({
                productCost: parseFloat(productCost),
                supplierShipping: parseFloat(supplierShipping),
                egsShipping: parseFloat(egsShipping),
                egsInternationalShipping: egsShippingCost,
                totalCostKRW: totalCostKRW,
                totalCostUSD: totalCostUSD,
                requiredSellingPriceUSD: requiredSellingPriceUSD,
                finalValueFee: ebayFeeBreakdown.finalValueFee,
                perOrderFee: ebayFeeBreakdown.perOrderFee,
                internationalFee: ebayFeeBreakdown.internationalFee,
                ebayFeeSubtotal: ebayFeeBreakdown.total,
                vatUSD: vatUSD,
                ebayTotalFee: ebayTotalFee,
                ebayPayoutUSD: ebayPayoutUSD,
                payoneerWithdrawalFee: payoneerWithdrawalFee,
                payoneerExchangeFee: payoneerExchangeFee,
                payoneerTotalFee: payoneerTotalFee,
                finalReceiveUSD: finalReceiveUSD,
                finalReceiveKRW: finalReceiveKRW,
                netProfitUSD: netProfitUSD,
                netProfitKRW: netProfitKRW,
                actualMarginRate: actualMarginRate,
                targetMarginRate: targetMarginRate,
                finalWeight: finalWeight,
                volumetricWeight: calculateVolumetricWeight(),
                exchangeRate: currentExchangeRate,
                hasStore: hasStore,
                isKoreanSeller: isKoreanSeller,
                destination: destination,
                category: category,
                serviceType: currentServiceType
            });
        }

        // *** THIS FUNCTION HAS BEEN COMPLETELY REWRITTEN ***
        function displayResults(results) {
            const resultDetailsContainer = document.getElementById('resultDetails');
            const settingsInfoContainer = document.getElementById('settingsInfo');
            const serviceName = results.serviceType === 'express' ? 'eGS Express 해외배송비' : 'eGS Standard 해외배송비';

            // 이미지 UI와 동일한 순서로 HTML 생성
            const resultHTML = `
                <!-- 총원가 -->
                <div style="padding-bottom: 12px; border-bottom: 1px solid #e5e7eb;">
                    <div class="result-item" style="font-size: 15px;">
                        <span class="text-red"><strong>총 원가 (KRW)</strong></span>
                        <span class="text-red"><strong>${results.totalCostKRW.toLocaleString()}원</strong></span>
                    </div>
                    <div class="result-item text-gray" style="font-size: 12px;">└ 제품원가(${results.productCost.toLocaleString()}) + 매입배송비(${results.supplierShipping.toLocaleString()}) + 입고비(${results.egsShipping.toLocaleString()}) + 국제배송비(${results.egsInternationalShipping.toLocaleString()})</div>
                </div>

                <!-- 권장 판매가 -->
                <div class="result-item total text-blue" style="margin: 12px 0;">
                    <span style="font-size: 16px;"><strong>💵 권장 판매가 (USD)</strong></span>
                    <span style="font-size: 16px;"><strong>$${results.requiredSellingPriceUSD.toFixed(2)}</strong></span>
                </div>

                <!-- eBay 수수료 상세 -->
                <div style="border-top: 1px dashed #d1d5db; padding-top: 12px;">
                    <div style="font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">eBay 수수료 상세</div>
                    <div class="result-item" style="font-size: 13px;"><span>• Final Value Fee:</span> <span>$${results.finalValueFee.toFixed(2)}</span></div>
                    <div class="result-item" style="font-size: 13px;"><span>• Per Order Fee:</span> <span>$${results.perOrderFee.toFixed(2)}</span></div>
                    <div class="result-item" style="font-size: 13px;"><span>• International Fee (1.65%):</span> <span>$${results.internationalFee.toFixed(2)}</span></div>
                    ${results.isKoreanSeller ? `<div class="result-item" style="font-size: 13px;"><span>• VAT (10%):</span> <span>$${results.vatUSD.toFixed(2)}</span></div>` : ''}
                    <div class="result-item text-red" style="margin-top: 4px; font-size: 14px;"><strong>eBay 총 수수료:</strong> <strong>$${results.ebayTotalFee.toFixed(2)}</strong></div>
                </div>

                <div class="result-item" style="background: #eff6ff; padding: 8px; border-radius: 4px; margin: 12px 0;">
                    <span><strong>eBay 정산액:</strong></span>
                    <span class="text-blue"><strong>$${results.ebayPayoutUSD.toFixed(2)}</strong></span>
                </div>
                
                <!-- Payoneer 수수료 상세 -->
                <div style="border-top: 1px dashed #d1d5db; padding-top: 12px;">
                    <div style="font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">Payoneer 수수료</div>
                    <div class="result-item" style="font-size: 13px;"><span>• 출금 수수료:</span> <span>$${results.payoneerWithdrawalFee.toFixed(2)}</span></div>
                    <div class="result-item" style="font-size: 13px;"><span>• 환전 수수료 (1.2%):</span> <span>$${results.payoneerExchangeFee.toFixed(2)}</span></div>
                    <div class="result-item text-red" style="margin-top: 4px; font-size: 14px;"><strong>Payoneer 총 수수료:</strong> <strong>$${results.payoneerTotalFee.toFixed(2)}</strong></div>
                </div>
                
                <!-- 최종 수령액 -->
                <div class="result-item total" style="background: #f0fdf4; padding: 12px; border-radius: 6px; margin-top: 16px;">
                    <span style="font-size: 16px;"><strong>💰 최종 수령액 (USD):</strong></span>
                    <span class="text-green" style="font-size: 16px;"><strong>$${results.finalReceiveUSD.toFixed(2)}</strong></span>
                </div>
                <div class="result-item total" style="background: #f0fdf4; padding: 12px; border-radius: 6px; margin-top: 8px;">
                    <span style="font-size: 16px;"><strong>💰 최종 수령액 (KRW):</strong></span>
                    <span class="text-green" style="font-size: 16px;"><strong>${results.finalReceiveKRW.toLocaleString()}원</strong></span>
                </div>
            `;
            resultDetailsContainer.innerHTML = resultHTML;

            // 계산 설정 정보 표시
            const serviceTypeText = results.serviceType === 'express' 
                ? '⚡ eGS Express (2-5일 배송)' 
                : '🚛 eGS Standard (5-10일 배송)';
            const settingsHTML = `
                <div style="font-size: 14px; line-height: 1.8;">
                    <div><strong>목적지:</strong> ${destinations[results.destination]}</div>
                    <div><strong>과금 중량:</strong> ${results.finalWeight.toFixed(2)}kg</div>
                    <div><strong>배송 서비스:</strong> ${serviceTypeText}</div>
                    <div><strong>카테고리:</strong> ${ebayCategories[results.category].name}</div>
                    <div><strong>스토어 구독:</strong> ${results.hasStore ? 'Basic 이상' : '없음/Starter'}</div>
                    <div><strong>판매자 유형:</strong> ${results.isKoreanSeller ? '한국 판매자 (VAT 10%)' : '해외 판매자'}</div>
                </div>
            `;
            settingsInfoContainer.innerHTML = settingsHTML;

            // 결과 컨테이너를 보이게 하고, 기본 안내는 숨김
            document.getElementById('resultsContainer').classList.remove('hidden');
            document.getElementById('usageGuide').classList.add('hidden');
        }
    </script>
</body>
</html>
